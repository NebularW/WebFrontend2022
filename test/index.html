<!DOCTYPE html>
<html lang="ch">

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
</head>

<body>
<h2>Hello OpenCV.js</h2>
<p id="status">OpenCV.js is loading...</p>
<div>
    <div class="inputoutput">
        <img id="imageSrc" alt="No Image"/>
        <div class="caption">imageSrc <input type="file" id="fileInput" name="file"/></div>
    </div>
    <div class="inputoutput">
        <canvas id="canvasOutput"></canvas>
        <div class="caption">canvasOutput</div>
    </div>
</div>
<script type="text/javascript">
    let imgElement = document.getElementById('imageSrc');
    let inputElement = document.getElementById('fileInput');
    inputElement.addEventListener('change', (e) => {
        imgElement.src = URL.createObjectURL(e.target.files[0]);
    }, false);
    imgElement.onload = function () {
        // 读取图像并获取B通道
        let src = cv.imread(imgElement);
        let rgbaPlanes = new cv.MatVector();
        cv.split(src, rgbaPlanes);
        let B = rgbaPlanes.get(2);

        // 将输入图像扩大到最佳尺寸
        let padded = new cv.Mat();
        let m = cv.getOptimalDFTSize(src.rows);
        let n = cv.getOptimalDFTSize(src.cols);
        cv.copyMakeBorder(B, padded, 0, m - src.rows, 0, n - src.cols, cv.BORDER_CONSTANT, cv.Scalar.all(0))

        // 把一个zeros通道和扩展通道合并在一起
        let temp = new cv.Mat();
        padded.convertTo(temp, cv.CV_32F);
        let planes = new cv.MatVector();
        planes.push_back(temp);
        planes.push_back(new cv.Mat(padded.size(), cv.CV_32F));
        let complexImage = new cv.Mat();
        cv.merge(planes, complexImage);

        // 进行傅里叶变换
        cv.dft(complexImage, complexImage);
        //放置水印文本
        cv.putText(complexImage, "Sky 201250044", {x:50,y:50}, cv.FONT_HERSHEY_SIMPLEX, 1.5, cv.Scalar.all(0), 6);


        // 将DFT实数和虚数部分变换成幅值
        cv.split(complexImage, planes);                 // planes[0]为DFT变换结果的实部，planes[1]为虚部
        let t = new cv.Mat();
        cv.magnitude(planes[0], planes[1], t);  // planes[0]存储幅值大小


        console.log("success until here");

    };

    function onOpenCvReady() {
        document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
    }
</script>
<script async src="./js/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</body>

</html>